"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const o=require("electron"),i=require("node:path"),R=require("node:url"),b=require("node:child_process"),u=require("node:fs");var h=typeof document<"u"?document.currentScript:null;const w=i.dirname(R.fileURLToPath(typeof document>"u"?require("url").pathToFileURL(__filename).href:h&&h.tagName.toUpperCase()==="SCRIPT"&&h.src||new URL("main.js",document.baseURI).href));process.env.APP_ROOT=i.join(w,"..");const g=process.env.VITE_DEV_SERVER_URL,D=i.join(process.env.APP_ROOT,"dist-electron"),f=i.join(process.env.APP_ROOT,"dist");process.env.VITE_PUBLIC=g?i.join(process.env.APP_ROOT,"public"):f;let e=null,p=null;const c=140;function m(){if(o.app.isPackaged){console.log("Running in packaged mode. Assuming API is already started by blackvault_run.bat");return}const n=process.env.APP_ROOT,s=i.join(n,"..","src","api.py");console.log("Starting Python backend at:",s);const t=process.platform==="win32"?i.join(n,"..",".venv","Scripts","python.exe"):i.join(n,"..",".venv","bin","python");p=b.spawn(t,[s],{cwd:i.join(n,".."),env:{...process.env,PYTHONIOENCODING:"utf-8"}}),p.stdout?.on("data",r=>{console.log(`API: ${r}`)}),p.stderr?.on("data",r=>{console.error(`API Error: ${r}`)})}function y(){const n=o.screen.getPrimaryDisplay(),{width:s,height:t}=n.workAreaSize;e=new o.BrowserWindow({icon:i.join(process.env.VITE_PUBLIC||"","electron-vite.svg"),webPreferences:{preload:i.join(w,"preload.js"),nodeIntegration:!0,contextIsolation:!0},width:c,height:c,x:s-c-20,y:t-c-20,frame:!1,transparent:!0,alwaysOnTop:!0,resizable:!1}),e.webContents.on("did-finish-load",()=>{e?.webContents.send("main-process-message",new Date().toLocaleString())}),e.setIgnoreMouseEvents(!1),g?e.loadURL(g):e.loadFile(i.join(f,"index.html"))}o.ipcMain.on("window-expand",()=>{if(e){const n=o.screen.getPrimaryDisplay(),{width:s,height:t}=n.workAreaSize,r=800,l=600;e.setResizable(!0),e.setBounds({x:s-r-20,y:t-l-20,width:r,height:l},!0)}});o.ipcMain.on("window-shrink",()=>{if(e){const n=o.screen.getPrimaryDisplay(),{width:s,height:t}=n.workAreaSize;e.setBounds({x:s-c-20,y:t-c-20,width:c,height:c}),e.setResizable(!1)}});o.ipcMain.on("window-expand-input",()=>{if(e){const n=o.screen.getPrimaryDisplay(),{width:s,height:t}=n.workAreaSize,r=400;e.setResizable(!0),e.setBounds({x:s-r-20,y:t-c-20,width:r,height:c})}});o.ipcMain.on("drag-out",(n,s)=>{try{const t=process.env.APP_ROOT,r=i.join(t,"..","blackvault_data","files"),l=s.replace(/\\/g,"/").split("/"),d=l[l.length-1],a=i.join(r,d);if(console.log("======================"),console.log(`[Drag Out Debug] Raw filePath string received: "${s}"`),console.log(`[Drag Out Debug] Parts array: ${JSON.stringify(l)}`),console.log(`[Drag Out Debug] Extracted fileName: "${d}"`),console.log(`[Drag Out Debug] Rebuilt absolute path: "${a}"`),console.log(`[Drag Out Debug] fs.existsSync result: ${u.existsSync(a)}`),console.log("======================"),!u.existsSync(a)){console.error(`❌ Drag out failed: file no longer exists on disk: "${a}"`),n.sender.send("drag-out-error",`El archivo buscado ya no existe en el Vault y no se puede extraer.
Ruta buscada: ${a}`);return}const A=o.nativeImage.createFromDataURL("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==").resize({width:32,height:32});n.sender.startDrag({file:a,icon:A}),console.log(`[Drag Out] Successfully started drag for: ${a}`)}catch(t){console.error("❌ Drag out exception:",t)}});o.ipcMain.on("open-file",async(n,s)=>{try{const t=process.env.APP_ROOT,r=i.join(t,"..","blackvault_data","files"),l=s.replace(/\\/g,"/").split("/"),d=l[l.length-1],a=i.join(r,d);if(console.log("======================"),console.log(`[Open File Debug] Raw filePath string received: "${s}"`),console.log(`[Open File Debug] Parts array: ${JSON.stringify(l)}`),console.log(`[Open File Debug] Extracted fileName: "${d}"`),console.log(`[Open File Debug] Rebuilt absolute path: "${a}"`),console.log(`[Open File Debug] fs.existsSync result: ${u.existsSync(a)}`),console.log("======================"),!u.existsSync(a)){console.error(`❌ Open file failed: file no longer exists on disk: ${a}`),n.sender.send("drag-out-error","El archivo ya no existe en el disco.");return}await o.shell.openPath(a)}catch(t){console.error("❌ Open file exception:",t)}});o.ipcMain.on("window-close",()=>{e&&e.close(),o.app.quit()});o.app.on("window-all-closed",()=>{p&&p.kill(),process.platform!=="darwin"&&(o.app.quit(),e=null)});o.app.on("quit",()=>{p&&p.kill()});o.app.on("will-quit",()=>{o.globalShortcut.unregisterAll()});o.app.on("activate",()=>{o.BrowserWindow.getAllWindows().length===0&&y()});o.app.whenReady().then(()=>{m(),y(),o.globalShortcut.register("CommandOrControl+Shift+B",()=>{e&&(e.isVisible()?e.hide():(e.show(),e.focus()))}),o.globalShortcut.register("CommandOrControl+Shift+Space",()=>{e&&(e.isVisible()||e.show(),e.focus(),e.webContents.send("shortcut-expand-search"))})});exports.MAIN_DIST=D;exports.RENDERER_DIST=f;exports.VITE_DEV_SERVER_URL=g;
